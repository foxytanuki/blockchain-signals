name: Feed Health Check

on:
  schedule:
    - cron: "0 9 * * 1" # Every Monday 09:00 UTC
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2

      - run: bun install --frozen-lockfile

      - name: Run health check
        run: bun run check-feeds > /tmp/report.md

      - name: Create issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('/tmp/report.md', 'utf8');
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Feed Health Check - ${new Date().toISOString().split('T')[0]}`,
              body,
              labels: ['feed-health']
            });

      - name: Remove dead feeds and create PR
        run: |
          DEAD_COUNT=$(cat /tmp/dead-feeds.json | bun -e 'const d=await Bun.stdin.json();console.log(d.length)')
          if [ "$DEAD_COUNT" = "0" ]; then
            echo "No dead feeds found."
            exit 0
          fi

          DATE=$(date +%Y-%m-%d)
          BRANCH="chore/remove-dead-feeds-${DATE}"
          git checkout -b "$BRANCH"

          bun scripts/remove-feeds.ts /tmp/dead-feeds.json

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add feeds.opml
          git commit -m "chore: remove ${DEAD_COUNT} dead feed(s) detected on ${DATE}"
          git push origin "$BRANCH"

          REPORT=$(cat /tmp/report.md)
          gh pr create \
            --title "Remove ${DEAD_COUNT} dead feed(s) - ${DATE}" \
            --body "$(cat <<EOF
          ## Auto-detected dead feeds

          The weekly health check found ${DEAD_COUNT} dead feed(s). This PR removes them from \`feeds.opml\`.

          <details>
          <summary>Full health check report</summary>

          ${REPORT}

          </details>
          EOF
          )" \
            --label "feed-health"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
